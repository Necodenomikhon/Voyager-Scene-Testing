<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Maps with Expandable Info</title>

  <!-- Leaflet (demo map behavior) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="./data-view.css"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 fill=%27%23121c2b%27/%3E%3Cpath d=%27M16 44l16-28 16 28H16z%27 fill=%27%23e8eefc%27/%3E%3C/svg%3E">
</head>

<body>

  <!-- Inline SVG icon set (no external icon/fonts) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-caret" viewBox="0 0 24 24">
      <path d="M9 6l8 6-8 6V6z"></path>
    </symbol>
    <symbol id="i-refresh" viewBox="0 0 24 24">
      <path d="M20 12a8 8 0 1 1-2.3-5.7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M20 4v6h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-help" viewBox="0 0 24 24">
      <path d="M12 18h.01" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M9.1 9a3 3 0 1 1 4.8 2.4c-.9.6-1.4 1.1-1.4 2.6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10z" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="i-map" viewBox="0 0 24 24">
      <path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M9 3v15" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M15 6v15" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="i-info" viewBox="0 0 24 24">
      <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 10v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M12 7h.01" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-zoom" viewBox="0 0 24 24">
      <path d="M10.5 18a7.5 7.5 0 1 1 7.5-7.5A7.5 7.5 0 0 1 10.5 18z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M21 21l-4.2-4.2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M10.5 7.5v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M7.5 10.5h6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-hand" viewBox="0 0 24 24">
      <path d="M7 11V6a1 1 0 0 1 2 0v5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M9 11V5a1 1 0 0 1 2 0v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M11 11V6a1 1 0 0 1 2 0v5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M13 11V7a1 1 0 0 1 2 0v7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M7 11v6a3 3 0 0 0 3 3h3.5a3.5 3.5 0 0 0 3.3-2.4l1.1-3.4a1.3 1.3 0 0 0-1.2-1.7H15" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-cube" viewBox="0 0 24 24">
      <path d="M12 2l9 5-9 5-9-5 9-5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M21 7v10l-9 5-9-5V7" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M12 12v10" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="i-pin" viewBox="0 0 24 24">
      <path d="M12 22s7-4.5 7-12a7 7 0 1 0-14 0c0 7.5 7 12 7 12z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 10.5a2.5 2.5 0 1 0-2.5-2.5 2.5 2.5 0 0 0 2.5 2.5z" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="i-comment" viewBox="0 0 24 24">
      <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-check" viewBox="0 0 24 24">
      <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-x" viewBox="0 0 24 24">
      <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
  </svg>

  <div class="app" id="appRoot">
    <div id="map"></div>

    <div class="rightRail">
      <div id="sideToggle" class="toggle center" title="Toggle panel"
           style="touch-action: pan-y; user-select: none; display: block;" data-title="Collapse">
        <svg class="ico ico-caret" aria-hidden="true"><use href="#i-caret"></use></svg>
      </div>

      <div id="sideElement">
        <div id="infoHeader" class="inline col12" style="touch-action: none; user-select: none;">
          <div class="titlePill">
            <span>Custom maps</span>
            <span id="activeCountLabel">0 active</span>
          </div>

          <div class="infoHeaderIcon" id="btnResetAll" title="Reset all overlays">
            <svg class="ico" aria-hidden="true"><use href="#i-refresh"></use></svg>
          </div>
          <div class="infoHeaderIcon" id="btnHelp" title="Help">
            <svg class="ico" aria-hidden="true"><use href="#i-help"></use></svg>
          </div>
        </div>

        <div class="sideScroll">
          <ul id="recordsTable" class="searchReturns noSort noselect"></ul>
        </div>

        <div class="attributionFooter">
          Basemap tiles: USGS The National Map (USGSTopo, USGSShadedReliefOnly). Overlay rendering: GeoTIFF via GeoRasterLayer. Map UI: Leaflet.
        </div>
      </div>
    </div>
  </div>
<script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.js"></script>
<script src="https://unpkg.com/georaster/dist/georaster.browser.bundle.min.js"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet@4.1.2/dist/georaster-layer-for-leaflet.min.js"></script>



<script>
/* ---------------------------
   Map
---------------------------- */
const map = L.map('map', { zoomControl:true, maxZoom:22 }).setView([41.615, -71.251], 11);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxNativeZoom: 19,
  maxZoom: 22,
  crossOrigin: true,
  errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
});

const usgsRelief = L.tileLayer(
  'https://basemap.nationalmap.gov/arcgis/rest/services/USGSShadedReliefOnly/MapServer/tile/{z}/{y}/{x}',
  {
    attribution: 'USGS The National Map',
    maxNativeZoom: 16,
    maxZoom: 22,
    crossOrigin: true,
    errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
  }
);

const usgsTopo = L.tileLayer(
  'https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}',
  {
    attribution: 'USGS The National Map',
    maxNativeZoom: 16,
    maxZoom: 22,
    crossOrigin: true,
    errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='
  }
);

let activeBase = usgsTopo;

function setActiveBasemap(layer){
  if (activeBase && map.hasLayer(activeBase)) map.removeLayer(activeBase);
  activeBase = layer;
  activeBase.addTo(map);
  map.setMaxZoom(activeBase.options.maxZoom ?? 22);
}

function addTileFailureFallback(primary, fallback){
  // If a provider starts 404'ing at high zoom, switch basemap instead of showing black tiles.
  let failures = 0;
  primary.on('tileerror', () => {
    failures++;
    if (failures >= 8){
      console.warn('Basemap failing; switching to fallback');
      setActiveBasemap(fallback);
      failures = 0;
    }
  });
  primary.on('load', () => { failures = 0; });
}

map.attributionControl.setPrefix('<a href="https://leafletjs.com/" target="_blank" rel="noopener">Leaflet</a>');

// Add basemap stack: relief under topo
usgsRelief.addTo(map);
setActiveBasemap(usgsTopo);

// fallback for both USGS layers
addTileFailureFallback(usgsTopo, osm);
addTileFailureFallback(usgsRelief, osm);


/* ---------------------------
   Sidebar collapse
---------------------------- */
const appRoot = document.getElementById('appRoot');
const sideToggle = document.getElementById('sideToggle');

function setCollapsed(collapsed){
  appRoot.classList.toggle('collapsed', collapsed);
  sideToggle.dataset.title = collapsed ? 'Expand' : 'Collapse';
  sideToggle.title = collapsed ? 'Expand panel' : 'Collapse panel';
}
setCollapsed(false);
sideToggle.addEventListener('click', () => setCollapsed(!appRoot.classList.contains('collapsed')));


/* ---------------------------
   Custom entries rendered in “record entry” markup style

   Each entry supports:
   - Show (toggle overlay)
   - Info (expand metaFields inline, like your snippet)
   - Zoom (fit bounds / setView)
   - Pan (panTo)
   - Pin (localStorage)
   - Fix (open fixUrl or mailto fallback)
   - Downloads (open provided URLs)
---------------------------- */

const PINS_KEY = 'custom_maps_pins_v2';

function loadPins(){
  try{
    const raw = localStorage.getItem(PINS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function savePins(pins){
  localStorage.setItem(PINS_KEY, JSON.stringify(pins));
}

const customEntries = [
  {
    id: 1,
    title: "GPR (GeoTIFF)",
    state: "—",
    year: 2024,
    series: "BHF",
    edition: "",
    scale: 0,
    thumb: "",

    // IMPORTANT: use absolute URL on GitHub Pages OR a relative path that actually exists
    geotiffUrl: "./maps/gpr_geo.tif",
    opacity: 0.7,

    // Optional: for Pan/Zoom before load; if unknown, omit and we use overlay bounds after load.
    // bounds: [[34.0, -86.0], [36.0, -84.0]],

    downloads: { },
    fixUrl: "",
    meta: { publishers: 'EduceLab', datum: 'Unstated', projection: 'Unstated', gnisCellId:'', gnisCell:'', woodlandTint:'Y' }
  },
  {
    id: 2,
    title: "Lidar (GeoTIFF)",
    state: "—",
    year: 2024,
    series: "BHF",
    edition: "",
    scale: 0,
    thumb: "",

    geotiffUrl: "./maps/lidar_geo.tif",
    opacity: 0.7,

    downloads: { },
    fixUrl: "",
    meta: { publishers: 'EduceLab', datum: 'Unstated', projection: 'Unstated', gnisCellId:'', gnisCell:'', woodlandTint:'Y' }
  }
];

// State + pins
const stateById = new Map(); // id -> {on, opacity, infoOpen, pinned}
const pins = new Set(loadPins());
const overlayById = new Map(); // id -> GeoRasterLayer

customEntries.forEach((e) => {
  stateById.set(e.id, {
    on: false,
    opacity: e.opacity ?? 0.9,
    infoOpen: false,
    pinned: pins.has(e.id)
  });
});

function setCounts(){
  const active = customEntries.filter(e => stateById.get(e.id).on).length;
  document.getElementById('activeCountLabel').textContent = `${active} active`;
}

function openDownload(url){
  window.open(url, '_blank', 'noopener,noreferrer');
}

function zoomToEntry(e){
  if (Array.isArray(e.bounds) && e.bounds.length === 2){
    map.fitBounds(e.bounds, { padding:[40,40], maxZoom: activeBase.options.maxNativeZoom ?? 16 });
    return;
  }
  const layer = overlayById.get(e.id);
  if (layer && layer.getBounds){
    map.fitBounds(layer.getBounds(), { padding:[40,40], maxZoom: activeBase.options.maxNativeZoom ?? 16 });
    return;
  }
  if (Array.isArray(e.center) && Number.isFinite(e.zoom)){
    map.setView(e.center, e.zoom, { animate:true });
  }
}

function panToEntry(e){
  if (Array.isArray(e.center)){
    map.panTo(e.center, { animate:true });
    return;
  }
  if (Array.isArray(e.bounds) && e.bounds.length === 2){
    const sw = e.bounds[0], ne = e.bounds[1];
    map.panTo([(sw[0]+ne[0])/2, (sw[1]+ne[1])/2], { animate:true });
    return;
  }
  const layer = overlayById.get(e.id);
  if (layer && layer.getBounds){
    const b = layer.getBounds();
    map.panTo(b.getCenter(), { animate:true });
  }
}

function reportFix(e){
  if (e.fixUrl){
    window.open(e.fixUrl, '_blank', 'noopener,noreferrer');
    return;
  }
  const subj = encodeURIComponent('Map issue report: ' + e.title);
  const body = encodeURIComponent(
    `Map: ${e.title} (${e.year})\n\nDescribe the issue:\n\nLocation (lat,lng): ${map.getCenter().lat.toFixed(5)}, ${map.getCenter().lng.toFixed(5)}\nZoom: ${map.getZoom()}\n`
  );
  window.location.href = `mailto:?subject=${subj}&body=${body}`;
}

function togglePin(id){
  const st = stateById.get(id);
  st.pinned = !st.pinned;
  if (st.pinned) pins.add(id); else pins.delete(id);
  savePins(Array.from(pins));
  render();
}

function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function metaItem(label, value, overflow=false){
  const ok = !(value == null || value === '');
  const textCls = ok ? '' : 'noData';
  const overflowCls = overflow ? 'overflow' : '';
  const val = ok ? escapeHtml(String(value)) : 'N/A';
  return `
    <span class="col12 metaItem">
      <span class="col1 metaIcon ${ok ? 'ok' : 'no'}" aria-hidden="true">
        <svg class="ico"><use href="${ok ? '#i-check' : '#i-x'}"></use></svg>
      </span>
      <span class="col11 metaField ${overflowCls} ${textCls}">${label}: ${val}</span>
    </span>
  `;
}

async function addGeoTiffOverlay(url, { opacity = 0.7 } = {}) {
  // IMPORTANT: Workers inside GeoTIFF libs sometimes need an absolute URL. Always resolve relative to page.
  const absUrl = new URL(url, window.location.href).href;

  const res = await fetch(absUrl, { mode: 'cors' });
  if (!res.ok) throw new Error(`GeoTIFF fetch failed: ${res.status} (${absUrl})`);
  const buf = await res.arrayBuffer();

  const georaster = await parseGeoraster(buf);

  const layer = new GeoRasterLayer({
    georaster,
    opacity,
    resolution: 256
  });

  layer.addTo(map);

  // Fit to raster bounds but DO NOT exceed basemap native zoom (prevents black/404 tiles)
  if (layer.getBounds){
    map.fitBounds(layer.getBounds(), {
      padding: [40, 40],
      maxZoom: activeBase.options.maxNativeZoom ?? 16
    });
  }

  return layer;
}

async function toggleEntryOverlay(entry){
  const st = stateById.get(entry.id);

  if (!st.on){
    // ON
    if (!overlayById.has(entry.id)){
      const layer = await addGeoTiffOverlay(entry.geotiffUrl, { opacity: st.opacity });
      overlayById.set(entry.id, layer);
    } else {
      overlayById.get(entry.id).addTo(map);
    }
    st.on = true;
  } else {
    // OFF
    const layer = overlayById.get(entry.id);
    if (layer) map.removeLayer(layer);
    st.on = false;
  }
}

const table = document.getElementById('recordsTable');

function render(){
  table.innerHTML = '';

  customEntries.forEach(e => {
    const st = stateById.get(e.id);
    const dls = e.downloads || {};

    const metaHtml = (() => {
      const m = e.meta || {};
      return `
        <span class="col12 metaFields noselect ${st.infoOpen ? 'open' : ''}">
          <span class="col11 metaInfo">
            <span class="col12 inline">
              <span class="metaPub col10">Publishers: ${escapeHtml(m.publishers ?? 'N/A')}</span>
              <span class="metaPubLink col1"></span>
              <span class="sbLink col1"></span>
            </span>

            <span class="col12 inline">
              <span class="col6 metaColumn">
                ${metaItem('Datum', m.datum)}
                ${metaItem('Projection', m.projection)}
                ${metaItem('GNIS Cell Id', m.gnisCellId)}
                ${metaItem('GNIS Cell', m.gnisCell, true)}
              </span>

              <span class="col6 metaColumn">
                ${metaItem('Woodland Tint', m.woodlandTint)}
              </span>
            </span>
          </span>
        </span>
      `;
    })();

    const li = document.createElement('li');
    li.className = st.infoOpen ? 'expanded' : '';

    li.innerHTML = `
      <a data-id="${e.id}">
        <span class="col12 pad1l inline">
          <span class="recTitle recKeyline searchItem col8">${escapeHtml(e.title)}, <span class="recState">${escapeHtml(e.state)}</span></span>

          <span class="col9">
            <span class="recYear searchItem pad05">${escapeHtml(e.year)}</span>
            <span class="searchItem">(${escapeHtml(e.series)}${e.edition ? ', ' + escapeHtml(e.edition) : ''}) </span>

            <span class="searchItem" style="padding-left:5px">Scale 1:</span><span class="recScale searchItem">${escapeHtml(e.scale)}</span>
            <br>

            <span class="col5 sideFile">
              <span class="downloadItem jpgDown col12 pad05" title="Download JPEG" aria-disabled="true">JPEG<span class="jpgByte">(N/A)</span></span>
              <span class="downloadItem kmzDown col12" title="Download KMZ" aria-disabled="true">KMZ<span class="kmzByte">(N/A)</span></span>
            </span>

            <span class="col5 sideFile">
              <span class="downloadItem gTifDown col12 pad05" title="Download GeoTiff" aria-disabled="true">GeoTiff<span class="tifByte">(N/A)</span></span>
              <span class="downloadItem pdfDown col12" title="Download GeoPDF" aria-disabled="true">GeoPDF<span class="pdfByte">(N/A)</span></span>
            </span>
          </span>

          <span class="col3 recImageMini lazy" style="background-image:url('${escapeHtml(e.thumb || '')}');"></span>

          <span class="col12 inline recordlinkGroup">
            <span class="col8 center">
              <span title="Show map" class="recordLinks dot showOverlay"><svg class="ico" aria-hidden="true"><use href="#i-map"></use></svg><span class="linkText overState">${st.on ? 'Hide' : 'Show'}</span></span>
              <span title="Map metadata" class="recordLinks dot moreInfo ${st.infoOpen ? 'infoShown' : ''}"><svg class="ico" aria-hidden="true"><use href="#i-info"></use></svg><span class="linkText">Info</span></span>
              <span title="Zoom to map" class="recordLinks dot zoomTo"><svg class="ico" aria-hidden="true"><use href="#i-zoom"></use></svg><span class="linkText">Zoom</span></span>
              <span title="Pan to map" class="recordLinks dot panTo"><svg class="ico" aria-hidden="true"><use href="#i-hand"></use></svg><span class="linkText">Pan</span></span>
            </span>

            <span class="center col4" style="text-indent: 4px;">
              <span title="Pin this map" class="recordLinks dot pinIt"><svg class="ico" aria-hidden="true"><use href="#i-pin"></use></svg><span class="linkText">${st.pinned ? 'Pinned' : 'Pin'}</span></span>
              <span title="Report errors" class="recordLinks dot mapComment"><svg class="ico" aria-hidden="true"><use href="#i-comment"></use></svg><span class="linkText" style="letter-spacing:0px;">Fix</span></span>
            </span>
          </span>

          ${metaHtml}
        </span>
      </a>
    `;

    // Wire events
    li.querySelector('.showOverlay').addEventListener('click', async (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      try{
        await toggleEntryOverlay(e);
      }catch(err){
        console.error(err);
        alert(String(err.message || err));
      }
      render();
    });

    li.querySelector('.moreInfo').addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      st.infoOpen = !st.infoOpen;
      render();
    });

    li.querySelector('.zoomTo').addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      zoomToEntry(e);
    });

    li.querySelector('.panTo').addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      panToEntry(e);
    });

    li.querySelector('.pinIt').addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      togglePin(e.id);
    });

    li.querySelector('.mapComment').addEventListener('click', (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      reportFix(e);
    });

    table.appendChild(li);
  });

  setCounts();
}

/* Reset all overlays */
document.getElementById('btnResetAll').addEventListener('click', () => {
  customEntries.forEach(e => {
    const st = stateById.get(e.id);
    st.on = false;
    st.infoOpen = false;
    const layer = overlayById.get(e.id);
    if (layer) map.removeLayer(layer);
  });
  render();
});

/* Help */
document.getElementById('btnHelp').addEventListener('click', () => {
  alert('Edit customEntries[] to add your GeoTIFF URLs (absolute URLs work best on GitHub Pages).');
});

/* Init */
render();
</script>
</body>
